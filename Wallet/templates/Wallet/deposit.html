{% extends 'index.html' %}
{% block title %}
    Make Deposit
{% endblock %}
{% block content %}
    <div class="container-fluid my-3">
        <div class="d-flex row">
            <div class="col-md-7">
                    <!-- Basic Validation -->
                    <div class="card mb-3 shadow no-b r-0">
                        <div class="card-header white">
                            <h5 class="bolder">Make Deposit</h5>
                        </div>
                        <div class="card-body">
                            <form id="i_form" class="needs-validation" novalidate method="post" action="{% url 'deposit' %}">
                                {% csrf_token %}
                                <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom01">Fund Source</label>
                                            <select class="form-control">
                                                <option>From Bank</option>
                                                <option>From Card</option>
                                            </select>
                                        <div class="valid-feedback">
                                            Looks good!
                                        </div>
                                    </div>
                                </div>
                                {% if card %}
                                <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom01">Select a Card</label>
                                            <select class="form-control">
                                                <option>5432 ********* 6754</option>
                                                <option>5436 ********* 9854</option>
                                            </select>
                                        <div class="valid-feedback">
                                            Looks good!
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                 <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom01">Select your Bank</label>
                                            <select class="form-control">
                                                <option>First Bank</option>
                                                <option>Skye Bank</option>
                                            </select>
                                        <div class="valid-feedback">
                                            Looks good!
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom03">Account Number</label>
                                        <input id="form_amt"  name="amount" type="text" class="form-control"  placeholder="Enter your Account Number" required>
                                        <small id="amt_warn" class="text-danger d-none">

                                        </small>
                                    </div>
                                 </div>

                                 <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom03">Amount</label>
                                        <input id="form_amt"  name="amount" type="text" class="form-control"  placeholder="Amount" required>
                                        <small id="amt_warn" class="text-danger d-none">

                                        </small>
                                    </div>
                                 </div>
                                <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom01">Bank OTP</label>
                                            <input class="form-control text-center" style="letter-spacing: 8px;" placeholder="******" type="password" minlength="6" maxlength="4"/>
                                        <div class="valid-feedback">
                                            Looks good!
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            {% if card %}
                                 <div class="form-row">
                                    <div class="col-md-12 mb-3">
                                        <label for="validationCustom01">Card Pin</label>
                                            <input class="form-control text-center" style="letter-spacing: 8px;" placeholder="****" type="password" minlength="4" maxlength="4"/>
                                        <div class="valid-feedback">
                                            Looks good!
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            </form>

                            <script>
                                // Example starter JavaScript for disabling form submissions if there are invalid fields
                                (function() {
                                    'use strict';
                                    window.addEventListener('load', function() {
                                        // Fetch all the forms we want to apply custom Bootstrap validation styles to
                                        var forms = document.getElementsByClassName('needs-validation');
                                        // Loop over them and prevent submission
                                        var validation = Array.prototype.filter.call(forms, function(form) {
                                            form.addEventListener('submit', function(event) {
                                                if (form.checkValidity() === false) {
                                                    event.preventDefault();
                                                    event.stopPropagation();
                                                }
                                                form.classList.add('was-validated');
                                            }, false);
                                        });
                                    }, false);
                                })();
                            </script>
                        </div>
                    </div>
                    <!-- #END# Basic Validation -->
                </div>
            <div class="col-md-5">
                <div class="card no-b shadow">
                    <div class="card-body">
                        <div class="my-4">
                            <span class="badge badge-success badge-pill">Deposit Information</span>

                        </div>
                         <div class="my-3">
                             {% if card %}
                             <small>Card</small>
                             <h3 id="show_plan">5342 ************ 6754</h3>
                             {% else %}
                             <small>Bank Name</small>
                             <h3 id="show_plan">First Bank</h3>
                             <small>Account Number</small>
                             <h3 id="show_plan">309764317736</h3>
                             {% endif %}
                         </div>
                        <div class="my-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong> <small>Deposited Amount: </small></strong>
                                  <div class="text-primary s-24 my-3"><span class="bolder">&#8358</span><span class="sc-counter" id="show_amt">0</span></div>
                                </div>
                                <div class="col-md-6">
                                    <strong> <small>Account Balance: </small></strong>
                                  <div class="text-primary s-24 my-3"><span class="bolder">&#8358</span><span class="sc-counter" id="show_amt">0</span></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                     <button class="btn btn-success" id="sub" type="submit">Proceed</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
      let first_element = document.getElementById('bank')
      let copier_element = document.getElementById('show_bank')
      first_element.onchange=()=>{
          if (validate_element(first_element)){
              consequence(first_element, copier_element)
          }
      }
      let first_element3 = document.getElementById('acct_num')
      let copier_element3 = document.getElementById('show_acct_num')
      first_element3.onkeyup=()=>{
          if (validate_element(first_element3)){
              consequence(first_element3, copier_element3)
          }
      }

      const validate_element = ele =>{
          return true
      }
let first_element2 = document.getElementById('amount')
      let copier_element2 = document.getElementById('show_amt')
      first_element2.onchange=()=>{
          if (validate_element(first_element2)){
              consequence2(first_element2, copier_element2)
          }
      }

      const consequence =(first, copier)=>{
           copier.innerText = first.value
        }

     const consequence2 =(first, copier)=>{
           $.ajax({
                url: "{% url 'account_balance' %}",
                json: true,
                success:(data)=>{
                    copier.innerText = first.value
                    let acct_balance = Number(data) - Number(first.value)
                    let acct_bal = document.getElementById('show_acct_bal')
                    acct_bal.innerText = acct_balance.toString()
                }
            })

        }


      let form = document.getElementById('i_form')
      let submit_button = document.getElementById('sub')
      submit_button.onclick=()=>{
          if (validate_form()){
              let otp = prompt('Please put in your 6 Digit Bank OTP')
              if (isNaN(Number(otp)) || otp.length !== 6){
                  alert('Invalid OTP')
              }else{
                  form.submit()
              }
          }

      }

   const validate_form =()=>{
       let bank = document.getElementById('show_bank')
       let acc__num = document.getElementById('show_acct_num')
       let account = document.getElementById('show_acct_bal')
       if (bank.innerText === 'undefined' || bank.innerText === ''){
           alert('No Bank Selected')
           return false
       }
       if (isNaN(Number(acc__num.innerText)) || acc__num.innerText === ''){
           alert('Invalid Account Number')
           return false
       }
       else if (isNaN(Number(account.innerText)) || Number(account.innerText) === 0) {
           alert('Invalid Amount')
           return false

       }else  if (Number(account.innerText) < 0){
           alert('Insufficient Funds')
           return false
       }else{
           return true
       }
   }








   </script>
{% endblock %}